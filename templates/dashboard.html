{% extends "base.html" %}

{% block title %}Dashboard - AI Research Assistant{% endblock %}

{% block content %}
<!-- Loading Overlay Element -->
<div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Generating...</div>
</div>

<div class="container-fluid py-4">
    <h1 class="mb-4">Welcome, {{ session.username }}!</h1>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Card 1: Summarize Topic -->
    <div class="card shadow-sm mb-4" id="topic-summary">
        <div class="card-body">
            <h5 class="card-title">Summarize by Topic</h5>
            <form action="{{ url_for('process') }}" method="POST" class="ai-form">
                <input type="hidden" name="input_type" value="topic">
                <div class="mb-3">
                    <label for="topic" class="form-label">Enter Topic:</label>
                    <input type="text" class="form-control" name="topic" id="topic" required>
                </div>
                <button type="submit" class="btn btn-primary">Generate</button>
            </form>
            <!-- Result for Topic Summary -->
            {% if result_type == 'topic' and summary %}
            <div class="mt-4">
                <hr>
                <h5 class="card-title d-flex justify-content-between align-items-center">
                    Generated Summary
                    <button class="btn btn-sm btn-outline-secondary read-aloud-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-up" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8a6.472 6.472 0 0 1-1.904 4.606l1.414 1.414zM10.121 12.596A4.47 4.47 0 0 0 12.026 8a4.47 4.47 0 0 0-1.905-3.596l-1.414 1.414A2.472 2.472 0 0 1 10.026 8a2.472 2.472 0 0 1-1.315 2.182l1.414 1.414zM8.707 11.182A.5.5 0 0 0 8 11.5v-7a.5.5 0 0 0-.707-.354L4.343 6.5H3a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h1.343l3.364 2.832zM7.5 4.64L5.646 6.5H3.5v2h2.146L7.5 10.36V4.64z"/></svg>
                        <span class="button-text">Read Aloud</span>
                    </button>
                </h5>
                <div class="summary-content">{{ summary|safe }}</div>
                {% if new_history_id %}<a href="{{ url_for('download', history_id=new_history_id) }}" class="btn btn-success mt-3">Download as PDF</a>{% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Card 2: Summarize URL -->
    <div class="card shadow-sm mb-4" id="url-summary">
        <div class="card-body">
            <h5 class="card-title">Summarize by URL</h5>
            <form action="{{ url_for('process') }}" method="POST" class="ai-form">
                <input type="hidden" name="input_type" value="url">
                <div class="mb-3">
                    <label for="url" class="form-label">Enter URL:</label>
                    <input type="url" class="form-control" name="url" id="url" required>
                </div>
                <button type="submit" class="btn btn-primary">Generate</button>
            </form>
            <!-- Result for URL Summary -->
            {% if result_type == 'url' and summary %}
            <div class="mt-4">
                <hr>
                <h5 class="card-title d-flex justify-content-between align-items-center">
                    Generated Summary
                     <button class="btn btn-sm btn-outline-secondary read-aloud-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-up" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8a6.472 6.472 0 0 1-1.904 4.606l1.414 1.414zM10.121 12.596A4.47 4.47 0 0 0 12.026 8a4.47 4.47 0 0 0-1.905-3.596l-1.414 1.414A2.472 2.472 0 0 1 10.026 8a2.472 2.472 0 0 1-1.315 2.182l1.414 1.414zM8.707 11.182A.5.5 0 0 0 8 11.5v-7a.5.5 0 0 0-.707-.354L4.343 6.5H3a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h1.343l3.364 2.832zM7.5 4.64L5.646 6.5H3.5v2h2.146L7.5 10.36V4.64z"/></svg>
                        <span class="button-text">Read Aloud</span>
                    </button>
                </h5>
                <div class="row">
                    <div class="{% if image_url %}col-md-8{% else %}col-md-12{% endif %}">
                        <div class="summary-content" style="height: 100%;">{{ summary|safe }}</div>
                    </div>
                    {% if image_url %}
                    <div class="col-md-4">
                        <div class="result-image-container">
                            <img src="{{ image_url }}" class="result-image" alt="Extracted from website">
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% if new_history_id %}<a href="{{ url_for('download', history_id=new_history_id) }}" class="btn btn-success mt-3">Download as PDF</a>{% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Card 3: Summarize PDF -->
    <div class="card shadow-sm mb-4" id="pdf-summary">
        <div class="card-body">
            <h5 class="card-title">Summarize from PDF</h5>
            <form action="{{ url_for('process') }}" method="POST" enctype="multipart/form-data" class="ai-form">
                <input type="hidden" name="input_type" value="pdf">
                <div class="mb-3">
                    <label for="file_summary" class="form-label">Upload PDF File:</label>
                    <input type="file" class="form-control" name="file" id="file_summary" accept=".pdf" required>
                </div>
                <button type="submit" class="btn btn-primary">Generate</button>
            </form>
            <!-- Result for PDF Summary -->
            {% if result_type == 'pdf' and summary %}
            <div class="mt-4">
                <hr>
                <h5 class="card-title d-flex justify-content-between align-items-center">
                    Generated Summary
                     <button class="btn btn-sm btn-outline-secondary read-aloud-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-up" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8a6.472 6.472 0 0 1-1.904 4.606l1.414 1.414zM10.121 12.596A4.47 4.47 0 0 0 12.026 8a4.47 4.47 0 0 0-1.905-3.596l-1.414 1.414A2.472 2.472 0 0 1 10.026 8a2.472 2.472 0 0 1-1.315 2.182l1.414 1.414zM8.707 11.182A.5.5 0 0 0 8 11.5v-7a.5.5 0 0 0-.707-.354L4.343 6.5H3a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h1.343l3.364 2.832zM7.5 4.64L5.646 6.5H3.5v2h2.146L7.5 10.36V4.64z"/></svg>
                        <span class="button-text">Read Aloud</span>
                    </button>
                </h5>
                <div class="summary-content">{{ summary|safe }}</div>
                {% if new_history_id %}<a href="{{ url_for('download', history_id=new_history_id) }}" class="btn btn-success mt-3">Download as PDF</a>{% endif %}
            </div>
            {% endif %}
        </div>
    </div>


    <!-- Card 5: Chat with PDF -->
    <div class="card shadow-sm mb-4" id="chat-with-pdf">
        <div class="card-body">
            <h5 class="card-title">Chat with PDF</h5>
            <form action="{{ url_for('chat_pdf') }}" method="POST" enctype="multipart/form-data" class="ai-form">
                <div class="mb-3">
                    <label for="file_chat" class="form-label">Upload PDF File:</label>
                    <input type="file" class="form-control" name="pdf_file" id="file_chat" accept=".pdf" required>
                </div>
                <div class="mb-3">
                    <label for="question" class="form-label">Your Question:</label>
                    <input type="text" class="form-control" name="question" id="question" required>
                </div>
                <button type="submit" class="btn btn-info">Ask Question</button>
            </form>
            <!-- Result for Chat -->
            {% if result_type == 'chat' and chat_answer %}
            <div class="mt-4">
                <hr>
                <h5 class="card-title d-flex justify-content-between align-items-center">
                    Answer from PDF
                     <button class="btn btn-sm btn-outline-secondary read-aloud-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-up" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8a6.472 6.472 0 0 1-1.904 4.606l1.414 1.414zM10.121 12.596A4.47 4.47 0 0 0 12.026 8a4.47 4.47 0 0 0-1.905-3.596l-1.414 1.414A2.472 2.472 0 0 1 10.026 8a2.472 2.472 0 0 1-1.315 2.182l1.414 1.414zM8.707 11.182A.5.5 0 0 0 8 11.5v-7a.5.5 0 0 0-.707-.354L4.343 6.5H3a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h1.343l3.364 2.832zM7.5 4.64L5.646 6.5H3.5v2h2.146L7.5 10.36V4.64z"/></svg>
                        <span class="button-text">Read Aloud</span>
                    </button>
                </h5>
                <div class="summary-content">{{ chat_answer|safe }}</div>
            </div>
            {% endif %}
        </div>
    </div>
    <!-- Ask Me Anything Card -->
    <div class="card shadow-sm mb-4" id="ask-anything">
        <div class="card-body">
            <h5 class="card-title">Ask Me Anything</h5>
            <form action="{{ url_for('ask') }}" method="POST" class="ai-form">
                <div class="mb-3">
                    <label for="question_ask" class="form-label">Enter your question, or use the microphone to speak:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" name="question" id="question_ask" required>
                        <button class="btn btn-outline-secondary" type="button" id="start-speech-btn">
                            <!-- Microphone Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic-fill" viewBox="0 0 16 16">
                                <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                                <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- Creativity Slider -->
                <div class="mb-3">
                    <label for="temperature_ask" class="form-label">Creativity (Temperature): <span id="temp_value_ask">0.7</span></label>
                    <input type="range" class="form-range" min="0" max="1" step="0.1" value="0.7" name="temperature" id="temperature_ask" oninput="document.getElementById('temp_value_ask').textContent = this.value">
                </div>
                <button type="submit" class="btn btn-primary">Get Answer</button>
            </form>
            <!-- Result for Ask Me Anything -->
            {% if result_type == 'ask' and ask_anything_answer %}
            <div class="mt-4">
                <hr>
                <h5 class="card-title d-flex justify-content-between align-items-center">
                    AI's Answer
                    <button class="btn btn-sm btn-outline-secondary read-aloud-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-up" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8a6.472 6.472 0 0 1-1.904 4.606l1.414 1.414zM10.121 12.596A4.47 4.47 0 0 0 12.026 8a4.47 4.47 0 0 0-1.905-3.596l-1.414 1.414A2.472 2.472 0 0 1 10.026 8a2.472 2.472 0 0 1-1.315 2.182l1.414 1.414zM8.707 11.182A.5.5 0 0 0 8 11.5v-7a.5.5 0 0 0-.707-.354L4.343 6.5H3a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h1.343l3.364 2.832zM7.5 4.64L5.646 6.5H3.5v2h2.146L7.5 10.36V4.64z"/></svg>
                        <span class="button-text">Read Aloud</span>
                    </button>
                </h5>
                <div class="summary-content">{{ ask_anything_answer|safe }}</div>
            </div>
            {% endif %}
        </div>
    </div>


</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Loading Spinner Logic ---
    const forms = document.querySelectorAll('.ai-form');
    const loadingOverlay = document.getElementById('loading-overlay');
    forms.forEach(form => {
        form.addEventListener('submit', function() {
            loadingOverlay.style.display = 'flex';
        });
    });

    // --- Read Aloud & Stop Logic ---
    const readAloudBtns = document.querySelectorAll('.read-aloud-btn');
    
    window.addEventListener('beforeunload', function() {
        speechSynthesis.cancel();
    });

    readAloudBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const resultBlock = this.closest('.mt-4');
            const contentDiv = resultBlock.querySelector('.summary-content');
            const textToSpeak = contentDiv.innerText;
            const buttonText = this.querySelector('.button-text');

            if (speechSynthesis.speaking && this.classList.contains('is-speaking')) {
                speechSynthesis.cancel();
                return;
            }

            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            if (textToSpeak) {
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                
                utterance.onstart = () => {
                    readAloudBtns.forEach(otherBtn => {
                        otherBtn.querySelector('.button-text').textContent = 'Read Aloud';
                        otherBtn.classList.remove('is-speaking');
                    });
                    buttonText.textContent = 'Stop';
                    this.classList.add('is-speaking');
                };

                utterance.onend = () => {
                    buttonText.textContent = 'Read Aloud';
                    this.classList.remove('is-speaking');
                };

                speechSynthesis.speak(utterance);
            }
        });
    });
});
</script>
{% endblock %}

